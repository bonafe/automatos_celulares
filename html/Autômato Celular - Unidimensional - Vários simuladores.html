<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Automata Celular - 2</title>
</head>
<body>	
	<script>
	
		class Universo{
			constructor (celulas, geracoes){
				this.regras = [0,1,1,0,1,0,1,0];
				this.geracao = 0;
				this.celulas = celulas;
				this.geracoes = geracoes;
				this.criarEspaco();				
			}
			
			atualizarRegras(regras){
				this.regras = regras;
			}
			
			criarEspaco(){
				this.espaco = new Array(this.geracoes);
				for (var geracao = 0; geracao < this.geracoes; geracao++){
					this.espaco [geracao] = new Array (this.celulas).fill(0);
				}				
			}
			
			definirPadrao(padrao){
				for (var celula = 0; celula < this.celulas; celula++){
					this.espaco[this.geracao][celula] = padrao[celula];
				}
			}
			
			gerarGeracaoRandomica(){
				var padrao = [];
				for (var celula = 0; celula < this.celulas; celula++){
					padrao.push(Math.round(Math.random()));
				}
				return padrao;
			}
			
			geracaoAnterior (geracao){
				var vGeracaoAnterior = geracao -1;
				if (vGeracaoAnterior < 0){
					vGeracaoAnterior = (this.geracoes-1);
				}
				return vGeracaoAnterior;
			}
			
			celulaAnterior(celula){
				
				var vCelulaAnterior = celula -1;
				if (vCelulaAnterior < 0){
					vCelulaAnterior = (this.celulas-1);
				}
				
				return vCelulaAnterior;
			}
			
			celulaPosterior(celula){
				
				var vCelulaPosterior = celula +1;
				if (vCelulaPosterior >= this.celulas){
					vCelulaPosterior = 0;
				}
				return vCelulaPosterior;
			}
			
			aplicarTempo(tempo){
				this.avancarGeracao();
				for (var celula = 0; celula < this.celulas; celula++){
					this.espaco[this.geracao][celula] = this.motorDeRegras(this.geracao, celula);
				}				
			}
					
			todosIguais (valor){
				for (var celula = 0; celula < this.celulas; celula++){
					if (this.espaco[this.geracao][celula] != valor){
						return false;
					}
				}	
				return true;
			}
			
			saturado(){
				return this.todosIguais(0) || this.todosIguais(1);
			}
			
			avancarGeracao(){
				this.geracao++;
				if (this.geracao >= this.geracoes){
					this.geracao = this.geracoes-1;
					this.espaco.shift();
					this.espaco.push(new Array(this.celulas).fill(0));
				}				
			}
				
			motorDeRegras(geracao, celula){
				
				var iGeracaoAnterior = this.geracaoAnterior(geracao);
				var a = this.espaco[iGeracaoAnterior][this.celulaAnterior(celula)];									
				var b = this.espaco[iGeracaoAnterior][celula];
				var c = this.espaco[iGeracaoAnterior][this.celulaPosterior(celula)];
				
				if      (a == 1 && b == 1 && c == 1) return this.regras[0];
				else if (a == 1 && b == 1 && c == 0) return this.regras[1];
				else if (a == 1 && b == 0 && c == 1) return this.regras[2];
				else if (a == 1 && b == 0 && c == 0) return this.regras[3];
				else if (a == 0 && b == 1 && c == 1) return this.regras[4];
				else if (a == 0 && b == 1 && c == 0) return this.regras[5];
				else if (a == 0 && b == 0 && c == 1) return this.regras[6];
				else if (a == 0 && b == 0 && c == 0) return this.regras[7];
			}
		}
	
		var tamanhoAresta = 10;
		var colunas = 10;
		var linhas = 50;				
		
		var elementos = [];
		
		function paddy(num, padlen, padchar) {
		    var pad_char = typeof padchar !== 'undefined' ? padchar : '0';
		    var pad = new Array(1 + padlen).join(pad_char);
		    return (pad + num).slice(-pad.length);
		}
		
		function gerarRegras(regra){
			return paddy(regra.toString(2), 8, 0);
		}
		
		function iniciar(){
			
			var body = document.getElementsByTagName("body")[0];
			
			var largura = 200;
			var altura = 200;
			
			var padrao = null;
			
			var regras = 0;
			
			for (var linha = 0; linha < linhas; linha++){
				for (var coluna = 0; coluna < colunas; coluna++){
					var canvas = document.createElement("canvas");
					
					canvas.style.top = altura*linha;
					canvas.style.left = largura*coluna;
					canvas.style.width = largura;
					canvas.style.height = altura;
					
					var universo = new Universo(Math.floor(largura/tamanhoAresta), Math.floor(altura/tamanhoAresta));
					
					if (padrao == null){
						padrao = universo.gerarGeracaoRandomica();
					}
					
					universo.definirPadrao(padrao);
					universo.atualizarRegras(gerarRegras(regras));
					elementos.push({"canvas":canvas, "universo":universo});
										
					body.appendChild(canvas);
					
					regras++;
				}
			}								
		}
		
		iniciar();
		setInterval(desenharElementos, 10);
		
		function rgb(r, g, b){
		  return "rgb("+r+","+g+","+b+")";
		}
		
		function desenharElementos(){
			for (var i = 0; i < elementos.length; i++){				
				desenhar(elementos[i]["canvas"], elementos[i]["universo"]);
			}
		}
		
		function desenhar(canvas, universo){
						
			var ctx = canvas.getContext("2d");
			
			for (var geracao = 0; geracao < universo.geracoes; geracao++){
				
				for (var celula = 0; celula < universo.celulas; celula++){
			
					var cor; 					
					if (universo.espaco[geracao][celula] == 1){					
						cor = rgb (255, 0, 0);
					}else{
						cor = rgb (0, 0, 0);
					}
					ctx.fillStyle =  cor;
															
					var x = celula*tamanhoAresta;
					var y = geracao*tamanhoAresta;
					ctx.fillRect (x, y, tamanhoAresta, tamanhoAresta);										
				}
			}
			universo.aplicarTempo(1);
			if (universo.saturado()){				
				universo.gerarGeracaoRandomica();
			}
		}		
						
	</script>
</body>
</html>